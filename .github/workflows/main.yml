name: Integration test
on:
  push:
    branches:
      - main
    tags-ignore:
      - "*"
  workflow_dispatch:

permissions: {}

jobs:
  test_job:
    runs-on: ubuntu-latest
    name: Test GitHub action
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Test action step
        uses: ./
        id: test
        with:
          # Triggers https://gitlab.com/digital-blueprint/gitlab-pipeline-trigger-action-example/-/pipelines
          host: "gitlab.com"
          trigger_token: ${{ secrets.DEPLOY_TRIGGER_TOKEN }}
          # Access token is required for private repositories and downloading artifacts/logs.
          access_token: ${{ secrets.DEPLOY_ACCESS_TOKEN }}
          id: "44347238"
          ref: "main"
          variables: '{"VAR1":"value1","VAR2":"value2"}'
          download_artifacts: "true"
          download_job_logs: "true"
          download_path: "./gitlab-artifacts"

      - name: List downloaded artifacts and job logs
        run: |
          echo "Artifacts directory contents:"
          ls -la ./gitlab-artifacts || echo "No artifacts directory found"
          if [ -d "./gitlab-artifacts" ]; then
            find ./gitlab-artifacts -type f | head -20
          fi

      - name: Get the output status
        run: echo "The status was ${STEPS_TEST_OUTPUTS_STATUS}"
        env:
          STEPS_TEST_OUTPUTS_STATUS: ${{ steps.test.outputs.status }}

      - name: Get the output web_url
        run: echo "The web_url was ${STEPS_TEST_OUTPUTS_WEB_URL}"
        env:
          STEPS_TEST_OUTPUTS_WEB_URL: ${{ steps.test.outputs.web_url }}

      - name: Get the output artifacts_downloaded
        run: echo "The artifacts_downloaded was ${STEPS_TEST_OUTPUTS_ARTIFACTS_DOWNLOADED}"
        env:
          STEPS_TEST_OUTPUTS_ARTIFACTS_DOWNLOADED: ${{ steps.test.outputs.artifacts_downloaded }}
